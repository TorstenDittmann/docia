name: Publish Package
on:
    release:
        types: [published]
    pull_request:
        branches: [main]

jobs:
    publish-npm:
        if: github.event_name == 'release'
        runs-on: ubuntu-latest
        environment: release
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v5
            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest
            - run: bun install --frozen-lockfile
            - run: bun publish --provenance --access public
              env:
                  NPM_CONFIG_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

    build-binaries:
        needs: publish-npm
        if: always() && (github.event_name == 'pull_request' || needs.publish-npm.result == 'success')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v5
            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest
            - run: bun install --frozen-lockfile
            - name: Get version
              id: get_version
              run: |
                  if [ "${{ github.event_name }}" = "release" ]; then
                      VERSION=${GITHUB_REF#refs/tags/v}
                  else
                      VERSION="pr-${{ github.event.number }}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
            - name: Build binaries
              run: |
                  mkdir -p dist
                  
                  # Darwin (macOS)
                  bun build --compile --target=bun-darwin-x64 ./src/cli.ts --outfile dist/docia-v${{ steps.get_version.outputs.version }}-darwin-x64
                  bun build --compile --target=bun-darwin-arm64 ./src/cli.ts --outfile dist/docia-v${{ steps.get_version.outputs.version }}-darwin-arm64

                  # Linux
                  bun build --compile --target=bun-linux-x64 ./src/cli.ts --outfile dist/docia-v${{ steps.get_version.outputs.version }}-linux-x64
                  bun build --compile --target=bun-linux-arm64 ./src/cli.ts --outfile dist/docia-v${{ steps.get_version.outputs.version }}-linux-arm64

                  # Windows
                  bun build --compile --target=bun-windows-x64 ./src/cli.ts --outfile dist/docia-v${{ steps.get_version.outputs.version }}-windows-x64.exe
                  bun build --compile --target=bun-windows-arm64 ./src/cli.ts --outfile dist/docia-v${{ steps.get_version.outputs.version }}-windows-arm64.exe

                  # Create compressed archives
                  cd dist

                  # macOS x64
                  tar -czf docia-v${{ steps.get_version.outputs.version }}-darwin-x64.tar.gz docia-v${{ steps.get_version.outputs.version }}-darwin-x64
                  # macOS arm64
                  tar -czf docia-v${{ steps.get_version.outputs.version }}-darwin-arm64.tar.gz docia-v${{ steps.get_version.outputs.version }}-darwin-arm64

                  # Linux x64
                  tar -czf docia-v${{ steps.get_version.outputs.version }}-linux-x64.tar.gz docia-v${{ steps.get_version.outputs.version }}-linux-x64
                  # Linux arm64
                  tar -czf docia-v${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz docia-v${{ steps.get_version.outputs.version }}-linux-arm64

                  # Windows x64
                  zip docia-v${{ steps.get_version.outputs.version }}-windows-x64.zip docia-v${{ steps.get_version.outputs.version }}-windows-x64.exe
                  # Windows arm64
                  zip docia-v${{ steps.get_version.outputs.version }}-windows-arm64.zip docia-v${{ steps.get_version.outputs.version }}-windows-arm64.exe
                  
                  # List files for debugging
                  ls -la
            - name: Upload binaries to release
              if: github.event_name == 'release'
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/docia-v${{ steps.get_version.outputs.version }}-darwin-x64.tar.gz
                      dist/docia-v${{ steps.get_version.outputs.version }}-darwin-arm64.tar.gz
                      dist/docia-v${{ steps.get_version.outputs.version }}-linux-x64.tar.gz
                      dist/docia-v${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz
                      dist/docia-v${{ steps.get_version.outputs.version }}-windows-x64.zip
                      dist/docia-v${{ steps.get_version.outputs.version }}-windows-arm64.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
